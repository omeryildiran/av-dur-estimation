# Psychometric Fitting for SIMULATED DATA - Quick Guide

## 🎯 Overview

This system fits psychometric functions to **simulated data** (specifically `lognorm_LapseFree_sharedPrior` model) and allows fast loading of results.

---

## 🚀 Quick Start

### Step 1: Run Batch Fitting (One Time)
```bash
python runDataFitter_simulated.py
```
⏱️ Takes ~3-5 minutes for all 12 participants

### Step 2: Use in Notebooks
```python
import psychometricFitLoader_simulated as pfl_sim

# Load single participant's simulated fit
fit = pfl_sim.load_psychometric_fit_simulated('mt', 'lognorm_LapseFree_sharedPrior')
print(f"AIC: {fit['AIC']:.2f}, Params: {len(fit['parameters'])}")

# Load all participants' simulated fits
summary = pfl_sim.get_fit_summary_simulated('lognorm_LapseFree_sharedPrior')
print(summary)

# Compare real data vs simulated data fits
comparison = pfl_sim.compare_data_vs_simulated('mt', 'lognorm_LapseFree_sharedPrior')
print(f"Delta AIC: {comparison['delta_AIC']:.2f}")
```

---

## 📁 File Structure

```
av-dur-estimation/
├── runDataFitter_simulated.py              # Main script for simulated data
├── psychometricFitSaver_simulated.py       # Fitting & saving functions
├── psychometricFitLoader_simulated.py      # Loading & comparison functions
├── test_psychometric_system_simulated.py   # Test/verification script
│
├── simulated_data/                         # Source simulated data
│   ├── as/
│   │   └── as_lognorm_LapseFree_sharedPrior_simulated.csv
│   ├── oy/
│   │   └── oy_lognorm_LapseFree_sharedPrior_simulated.csv
│   └── ...
│
└── psychometric_fits_simulated/            # Saved fits (created after first run)
    ├── as/
    │   └── as_lognorm_LapseFree_sharedPrior_simulated_psychometric_fit.json
    ├── oy/
    │   └── oy_lognorm_LapseFree_sharedPrior_simulated_psychometric_fit.json
    └── ...
```

---

## 🔑 Key Functions

### Loading Simulated Fits
```python
import psychometricFitLoader_simulated as pfl_sim

# Load one participant
fit = pfl_sim.load_psychometric_fit_simulated('as', 'lognorm_LapseFree_sharedPrior')

# Load all participants for a model type
all_fits = pfl_sim.load_all_psychometric_fits_simulated('lognorm_LapseFree_sharedPrior')

# Get summary table
summary = pfl_sim.get_fit_summary_simulated('lognorm_LapseFree_sharedPrior')

# Get just parameters
params = pfl_sim.get_parameters_simulated('mt', 'lognorm_LapseFree_sharedPrior')
```

### Comparing Data vs Simulated
```python
# Compare single participant
comparison = pfl_sim.compare_data_vs_simulated(
    'mt', 
    'lognorm_LapseFree_sharedPrior',
    data_fits_dir='psychometric_fits_data',
    sim_fits_dir='psychometric_fits_simulated'
)

print(f"Data AIC: {comparison['data_AIC']:.2f}")
print(f"Simulated AIC: {comparison['simulated_AIC']:.2f}")
print(f"Delta: {comparison['delta_AIC']:.2f}")

# Get comparison table for all participants
participant_ids = ["as", "oy", "dt", "HH", "ip", "ln", "LN01", "mh", "ml", "mt", "qs", "sx"]
comp_table = pfl_sim.get_all_comparisons(participant_ids, 'lognorm_LapseFree_sharedPrior')
print(comp_table)
```

---

## 📊 What Gets Saved

Each simulated fit includes:
- **Fitted parameters** (lambda, mu, sigma for each condition)
- **Model metrics** (AIC, BIC, log-likelihood)
- **Model type** (e.g., "lognorm_LapseFree_sharedPrior")
- **Source file** (path to simulated CSV)
- **Metadata** (n_params, n_conditions, n_trials)
- **Condition info** (unique noise levels, standards, conflicts)

---

## 💡 Example Use Cases

### 1. Model Recovery Analysis
```python
import psychometricFitLoader_simulated as pfl_sim
import psychometricFitLoader as pfl_data

# Load fits from real data
data_fit = pfl_data.load_psychometric_fit('mt')

# Load fits from simulated data (generated by lognorm model)
sim_fit = pfl_sim.load_psychometric_fit_simulated('mt', 'lognorm_LapseFree_sharedPrior')

# Compare parameter recovery
print(f"Real data AIC: {data_fit['AIC']:.2f}")
print(f"Simulated data AIC: {sim_fit['AIC']:.2f}")

# If AICs are similar, the model recovers well!
```

### 2. Batch Comparison Across Participants
```python
import psychometricFitLoader_simulated as pfl_sim
import matplotlib.pyplot as plt

participant_ids = ["as", "oy", "dt", "HH", "ip", "ln", "LN01", "mh", "ml", "mt", "qs", "sx"]
comparisons = pfl_sim.get_all_comparisons(participant_ids, 'lognorm_LapseFree_sharedPrior')

# Plot Delta AIC
plt.figure(figsize=(12, 6))
plt.bar(comparisons['participantID'], comparisons['delta_AIC'])
plt.xlabel('Participant')
plt.ylabel('Delta AIC (Simulated - Data)')
plt.title('Model Recovery: Simulated vs Real Data')
plt.axhline(y=0, color='r', linestyle='--')
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()
```

### 3. Extract PSE Values from Simulated Fits
```python
import psychometricFitLoader_simulated as pfl_sim

fit = pfl_sim.load_psychometric_fit_simulated('mt', 'lognorm_LapseFree_sharedPrior')
params = fit['parameters']

# Parameters structure: [lambda, mu1, sigma1, mu2, sigma2, ...]
n_conditions = (len(params) - 1) // 2
pse_values = [params[1 + i*2] for i in range(n_conditions)]

print(f"PSE values from simulated data: {pse_values}")
```

---

## 🔄 Workflow Integration

### Complete Analysis Pipeline
```python
import psychometricFitLoader as pfl_data
import psychometricFitLoader_simulated as pfl_sim

# 1. Load real data fits
data_summary = pfl_data.get_fit_summary()
print("Real Data Fits:")
print(data_summary)

# 2. Load simulated data fits
sim_summary = pfl_sim.get_fit_summary_simulated('lognorm_LapseFree_sharedPrior')
print("\nSimulated Data Fits:")
print(sim_summary)

# 3. Compare across all participants
participant_ids = data_summary['participantID'].tolist()
comparisons = pfl_sim.get_all_comparisons(participant_ids, 'lognorm_LapseFree_sharedPrior')

# 4. Statistical analysis
import numpy as np
mean_delta_aic = comparisons['delta_AIC'].mean()
std_delta_aic = comparisons['delta_AIC'].std()

print(f"\nMean Delta AIC: {mean_delta_aic:.2f} ± {std_delta_aic:.2f}")
print(f"Model recovery {'GOOD' if abs(mean_delta_aic) < 10 else 'POOR'}")
```

---

## 🛠️ Advanced Usage

### Fit Different Model Types
To fit other model types (e.g., gaussian, logLinearMismatch), modify `runDataFitter_simulated.py`:

```python
# Change MODEL_TYPE to fit different simulations
MODEL_TYPE = "gaussian_LapseFree_sharedPrior"
# or
MODEL_TYPE = "logLinearMismatch_LapseFree_sharedPrior"
```

Then run:
```bash
python runDataFitter_simulated.py
```

---

## 📈 Performance

| Action | Time |
|--------|------|
| Fit 1 participant (simulated) | ~15-25 sec |
| Fit all 12 participants | ~3-5 min |
| Load 1 participant | <0.05 sec |
| Load all 12 participants | ~0.5 sec |

**Note:** Simulated data typically fits faster than real data because it's cleaner (less noise).

---

## ✅ Verification

Run the test script to verify everything works:
```bash
python test_psychometric_system_simulated.py
```

This checks:
- ✅ All required files exist
- ✅ Modules import correctly
- ✅ Simulated data files are present (12/12)
- ✅ Fits can be loaded (if generated)

---

## 🆚 Comparison: Data vs Simulated

| Feature | Real Data Fits | Simulated Data Fits |
|---------|---------------|---------------------|
| **Script** | `runDataFitter.py` | `runDataFitter_simulated.py` |
| **Loader** | `psychometricFitLoader.py` | `psychometricFitLoader_simulated.py` |
| **Source** | `data/*.csv` | `simulated_data/*/*.csv` |
| **Output Dir** | `psychometric_fits_data/` | `psychometric_fits_simulated/` |
| **Purpose** | Fit observed behavior | Test model recovery |

---

## 📝 Next Steps

1. **Generate simulated fits:**
   ```bash
   python runDataFitter_simulated.py
   ```

2. **Compare with real data fits:**
   ```python
   import psychometricFitLoader_simulated as pfl_sim
   comparisons = pfl_sim.get_all_comparisons(participant_ids, 'lognorm_LapseFree_sharedPrior')
   print(comparisons[['participantID', 'delta_AIC', 'delta_BIC']])
   ```

3. **Analyze model recovery:**
   - If Delta AIC ≈ 0: Great model recovery!
   - If Delta AIC > 10: Model may not capture data well
   - Compare across participants for consistency

---

## 🎓 Integration with Notebooks

Add these cells at the top of your analysis notebooks:

```python
# Load simulated fits
import psychometricFitLoader_simulated as pfl_sim

# Load simulated fit for current participant
sim_fit = pfl_sim.load_psychometric_fit_simulated('mt', 'lognorm_LapseFree_sharedPrior')

# Compare with real data
comparison = pfl_sim.compare_data_vs_simulated('mt', 'lognorm_LapseFree_sharedPrior')
print(f"Model recovery Delta AIC: {comparison['delta_AIC']:.2f}")
```

---

**Ready to analyze! 🎉**

For questions or issues, check the test script output or the main README files.
